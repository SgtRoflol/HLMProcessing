/* autogenerated by Processing revision 1293 on 2024-01-23 */
import processing.core.*;
import processing.data.*;
import processing.event.*;
import processing.opengl.*;

import java.util.HashMap;
import java.util.ArrayList;
import java.io.File;
import java.io.BufferedReader;
import java.io.PrintWriter;
import java.io.InputStream;
import java.io.OutputStream;
import java.io.IOException;

public class Spiel3 extends PApplet {

Camera worldCamera;
Player Play;
Weapon[] Waffen;
Weapon curWeapon;
int weapInd;


public void setup() {
    weapInd = 0;
    frameRate(60);
    /* smooth commented out by preprocessor */;
    /* size commented out by preprocessor */;
    worldCamera = new Camera(); // Worldcamera wird genutzt, um Level größer als der Screen erstellen zu können
    Play = new Player();
    Waffen = new Weapon[3];
    Waffen[0] = new Weapon("Waffe",30,10,5,50);// Konstruktor -> String Name, int maxAmmo, int projSpeed, int cad
    Waffen[1] = new Weapon("Waffe2",10,20,30,60);
    Waffen[2] = new Weapon("Waffe3",5,40,70,100); 
    curWeapon = Waffen[weapInd]; // Aktuelle Waffe
}

public void draw() {
    background(255);
    //Alles andere muss nach der Worldcamera gezeichnet werden!
    pushMatrix();
    translate( -worldCamera.pos.x, -worldCamera.pos.y); //Worldcam verschiebt Achsen um Bewegungswert
    worldCamera.draw();
    for (int i = 0; i < Waffen.length; i++) {
        Waffen[i].render();
    }
    curWeapon.shoot();
    
    //WorldCamera Ende
    rect(25,25,25,25);
    popMatrix();
    
    fill(0);
    //Zeigt Waffenname und Munition
    textSize(35);
    
    text(curWeapon.ammo,30,40);
    if (curWeapon.cooldown != 0) {
        fill(255,0,0);
    }
    text(curWeapon.Name,30,70);
    fill(255);
    
    Play.move();
    
    
    
}

public void mousePressed() {
    curWeapon.isShooting = true; //Wird gesetzt um beständiges Schießen bei Halten der Maustaste zu ermöglichen
}

public void mouseReleased() {
    curWeapon.isShooting = false;
}

public void keyPressed() {
    //Zwischen Waffen wechseln
    switchWeapons();
    
    //Es kann nur nachgeladen werden, wenn geschossen wird, ausserdem kann einige Zeit nicht geschossen
    //werden, um dauerladen und Schießen zu vermeiden
    if (!curWeapon.isShooting) {
        curWeapon.reload();
    }
}

public void switchWeapons() {
    // Akutelle Waffe wird auf Waffe aus Array an allen Waffen gesetzt, somit können diese gewechselt werden
    if (key == 'e' && weapInd < Waffen.length - 1) {
        curWeapon = Waffen[weapInd + 1];
        weapInd++;
    }
    if (key == 'q' && weapInd > 0) {
        curWeapon = Waffen[weapInd - 1];
        weapInd--;
    }
    
}

class Camera {
    PVector pos;
    
    Camera() {
        pos = new PVector(0, 0);
    }
    
    public void draw() {
        if (keyPressed) {
            if (key == 'w') pos.y -= 5;
            if (key == 's') pos.y += 5;
            if (key == 'a') pos.x -= 5;
            if (key == 'd') pos.x += 5;
        }
    }
}
class Player{
    float angle;
    float x;
    float y;
    int farbe;
    
    Player() {
        x = width / 2;
        y = height / 2;
        farbe = color(255,0,0,10);
    }
    
    public void render() {
        int curcol = g.fillColor;
        fill(farbe);
        rectMode(CENTER);
        rect(0,0,50,50);
        fill(curcol);
    }
    
    
    public void move() {
        pushMatrix();
        angle = atan2(x - mouseX, y - mouseY);
        translate(x, y);
        rotate( -angle - HALF_PI);
        render();
        popMatrix();
    }
    
}
class Projectile{
    boolean isActive;
    PVector Pos;
    float speed;
    PVector dir;
    
    Projectile(float speed) {
        this.speed = speed;
        init();
    }
    
    public void init() {
        isActive = false;
        Pos = new PVector(width / 2,height / 2);
        Pos.x = worldCamera.pos.x + width / 2;
        Pos.y = worldCamera.pos.y + height / 2;
        dir = new PVector(0,0);
    }
    
    public void spawn() {
        init();
        PVector mouse = new PVector(worldCamera.pos.x + mouseX,worldCamera.pos.y + mouseY);
        dir = PVector.sub(mouse,Pos);
        dir.normalize();
        dir.mult(speed);
        isActive = true;
        Pos.x = worldCamera.pos.x + width / 2;
        Pos.y = worldCamera.pos.y + height / 2;
    }
    
    public void render() {
        ellipseMode(CENTER);
        int curcol = g.fillColor;
        fill(255, 255, 0);
        if (isActive) {
            checkBounds();
            Pos = Pos.add(dir);
            ellipse(Pos.x,Pos.y,10,10);
        }
        else{
            Pos.x = worldCamera.pos.x + width / 2;
            Pos.y = worldCamera.pos.y + height / 2;
            ellipse(Pos.x,Pos.y,10,10);
        }
        fill(curcol);
    }
    
    public void checkBounds() {
        if (Pos.x > worldCamera.pos.x + width || Pos.x < worldCamera.pos.x) {
            init();
        }
        
        if (Pos.y > worldCamera.pos.y + height || Pos.y < worldCamera.pos.y) {
            init();
        }
    }
    
}
class Weapon{
    String Name;
    int ammo;
    int maxAmmo;
    Projectile[] Bullets;
    boolean isShooting = false;
    int projSpeed;
    float cad;
    float cooldown = 0;
    float reloadTime;
    
    Weapon(String Name, int maxAmmo, int projSpeed, int cad,float reloadTime) {
        this.Name = Name;
        this.maxAmmo = maxAmmo;
        this.ammo = maxAmmo;
        this.projSpeed = projSpeed;
        Bullets = new Projectile[ammo];
        for (int i = 0; i < Bullets.length; i++) {
            Bullets[i] = new Projectile(projSpeed);
        }
        this.cad = cad;
        this.reloadTime = reloadTime;
        
        
    }
    
    public void render() {        for (int i = 0; i < Bullets.length; i++) {
            Bullets[i].render();
        } 
        
        if (cooldown > 1.0f) {
            cooldown--;
        }  
        
        else{
            cooldown = 0;
        }
        println(cooldown);
    }
    
    public void shoot() {
        if (isShooting && cooldown == 0) {
            for (int i = 0; i < Bullets.length; i++) {
                if (!Bullets[i].isActive && ammo != 0) {
                    Bullets[i].spawn();
                    ammo--;
                    cooldown = cad;
                    break;
                }
            }
        }
        
    }
    
    public void reload() {
        if (key == 'r') {
            cooldown = reloadTime;
            ammo = maxAmmo;
        }
    }
    
}


  public void settings() { size(640, 640);
smooth(4); }

  static public void main(String[] passedArgs) {
    String[] appletArgs = new String[] { "Spiel3" };
    if (passedArgs != null) {
      PApplet.main(concat(appletArgs, passedArgs));
    } else {
      PApplet.main(appletArgs);
    }
  }
}
